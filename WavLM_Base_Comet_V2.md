# 用 WavLM Base（层 2 / 6 / 10）做“语义彗星轨迹（Comet Trail）”实时可视化 —— V2 实施文档

**版本**：v2.0（实时增强 / 语义扩展 / 表演模式）  
**模型**：`microsoft/wavlm-base`（12 层）  
**指定层**：**L2 / L6 / L10**（见 §2）  
**用途**：评审演示、创意互动展示、可解释听觉表征可视化  
**说明**：本文件为**流程与参数指南**，不含代码。

---

## 1) 目标与亮点（30 秒摘要）

- **目标**：把连续语音在 WavLM Base 的隐藏空间里形成的“时间轨迹”可视化为一条**带尾迹的彗星**，让观众直观看到节奏、说话人与内容层次的变化。  
- **亮点**：  
  1. **实时性**：主通道采用 **PCA-only** 的低延迟映射，端到端主观延迟 **≈150–200 ms**；UMAP 作为回放/后台增强。  
  2. **语义与情感**：在 **L10** 上增加**关键词浮现**、**主题背景**、**情感指示（效价/唤醒度）**。  
  3. **表演模式**：节拍脉冲、多说话人交织、情绪共振；观众可拖动滑块改变映射风格。

---

## 2) 模型与层位选择（Base：12 层）

**索引说明**：`hidden_states[0]` 为输入嵌入；`hidden_states[1]` 为第 1 层输出；…；`hidden_states[12]` 为第 12 层（最后一层）。

**推荐三层**：  
- **L2（早期底层）**：对**声纹/说话人**与低级声学差异最稳定；适合用于**颜色**或背景声学通道。  
- **L6（中层桥梁）**：对**韵律/重音/节奏**响应明显，承接“谁在说 ↔ 怎么说”；适合做**主轨迹**或节奏通道。  
- **L10（偏顶层语义）**：对**内容/语义**更敏感，适用于**关键词/主题/情感指示**。

> 采用 L2/L6/L10 的组合，可近似覆盖：说话人（底层）→韵律（中层）→语义（高层）的信息梯度。

---

## 3) 实时体系结构（< 200 ms 主观延迟）

**帧化与缓冲**  
- **采样率**：16 kHz；**帧窗** 40 ms；**步长** 20 ms（50% 重叠）。  
- **环形缓冲**：输入缓冲 120–160 ms，用于稳定更新与尾迹平滑。  
- **刷新频率**：5–8 Hz（每 3–4 帧刷新一次）。

**处理管线（低延迟路径）**  
1. 音频帧化 → WavLM Base 前向（取 **L6** 为主）  
2. **PCA-32** 线性投影至 2D（或 PCA-32 + 2D 线性头）  
3. 轨迹平滑（时间 EMA，τ ≈ 0.25 s）与尾迹绘制（2–3 s）  
4. 视觉通道映射（色相/线宽/亮度/粒子） → 显示

**后台增强（低频路径）**  
- **UMAP（PCA→UMAP）**：先用 10–20 秒暖场数据拟合，仅在后台/回放时使用 `transform`；或在静止帧间隔逐步刷新。  
- **语义与情感模块**：每 **0.5–1.0 s** 更新关键词/主题/情感，不阻塞主通道。

**容错策略**  
- **丢帧**：GPU 忙时跳过中间帧，只渲染最新窗口。  
- **降级**：UMAP 卡顿即回退为 PCA-only；关键词/主题模块延迟不影响主体验。

---

## 4) 降维策略与对比

- **主实时映射**：**PCA-only**（至 2D 或 32D→线性 2D），矩阵乘开销小、稳定、可流式更新。  
- **高级可读性**：**PCA→UMAP**（邻居 30、最小距离 0.1、余弦度量）在回放或后台低频刷新时使用，呈现更“结构化”的簇与转场。  
- **参数化替代**（可选）：Parametric UMAP / 轻量前馈投影网络，训练一次、在线推理快。

---

## 5) 视觉映射规范（“一通道一语义”）

**尾迹与平滑**  
- 尾迹长度：**2–3 s**；时间平滑：EMA（τ ≈ 0.25 s）；刷新：5–8 Hz。  
- 轨迹头部适度放大与发光，尾迹随时间衰减透明度。

**通道映射（建议）**  

| 语音/表征信号 | 来源层/方法 | 可视通道 | 规则与提示 |
|---|---|---|---|
| 说话人/状态 | L2 或 PCA32 上的聚类 | **颜色（色相）** | 固定色盘；同一说话人颜色全程一致 |
| 能量（RMS） | 波形帧级 | **线宽** | 归一后非线性（平方/对数）放大，高能更粗 |
| 音高（F0） | YIN/CREPE 等 | **亮度/光晕** | 归一到 [0,1]；高音更亮、更“发光” |
| 重音/爆破 | RMS 二阶导/峰值 | **粒子/火花** | 超阈触发，短寿命渐隐 |
| 韵律活跃 | L6 局部能量 | **虚线密度/速度** | 活跃更密更快，静淡更稀更慢 |
| 语义强度 | L10 范数/方差 | **尾迹透明度** | 强度高 → 尾迹更亮更长 |

> 避免让**同一视觉通道**（如颜色）同时编码多种含义。

---

## 6) 语义与情感扩展（轻量、门控、低频刷新）

- **关键词浮现**（what’s being said）  
  - 来源：L10 上的轻量关键词探针或小型 ASR（tiny / distil 级）在 0.5–1.0 s 窗口上取“候选词”。  
  - 显示：彗星头部附近短暂浮现 1–2 个词；**置信度门控 + 去重**；透明度随置信度/持续度衰减。

- **主题检测**（domain/style）  
  - 来源：PCA32 上的 KMeans（K≈8–12）或句向量小头。  
  - 显示：**背景色域/纹理**缓慢变化（秒级），确保稳定。

- **情感指示**（valence–arousal）  
  - 来源：RMS/F0/节奏 + L10 探针估计二维情感坐标。  
  - 显示：**光晕大小/粒子频率** 随唤醒度变化，**色温** 随效价变化。  
  - 文案：标注为“**指示**/线索”，非绝对标签。

- **语速映射**  
  - 依据：音节速率/能量峰密度/ASR token 速率。  
  - 显示：轨迹点**密度与曲率**上升，表现“快语速”。

---

## 7) 表演模式（Performance）与互动

- **模式切换**：Analysis（默认、稳） / Performance（炫、互动）。  
- **节拍脉冲**：检测强重音 → 外圈脉冲同步闪烁。  
- **多人对话**：不同说话人→**多条彗星**交织，轨迹相遇处画“交互弧线”。  
- **情绪共振**：激动时**尾迹加粗+粒子爆裂**；平静时**收束+透明度升**。  
- **观众控制台**：线宽增益、尾迹长度、色盘、关键词密度、粒子阈值、亮度/速度增益；实时可调。

---

## 8) 质量背书（让“好看”变“可信”）

- **相关性**：轨迹速度/曲率 与 RMS/F0/停顿 的秩相关；主题/情感指示 与相应特征的互信息。  
- **状态结构**：PCA32 上的帧级聚类 → **时间状态条**与**转移矩阵**（热图），与彗星轨迹联动展示“站点换乘”。  
- **轻因果（回放/后台）**：对 L10 的若干主方向或局部邻域做小幅抑制/置零，观察 ASR/探针置信变化；仅对变化显著的片段打“影响大”标记。  
- **跨说话人一致性**：固定说话人色盘，展示不同人下相似韵律产生的相似轨迹形态。

---

## 9) 参数建议（可直接采用）

- **帧化**：40 ms 窗 / 20 ms 步；采样率 16 kHz  
- **尾迹**：2.5 s（≈125 帧）；**平滑**：EMA τ≈0.25 s；**刷新**：5–8 Hz  
- **降维**：PCA 直接到 2D 或 PCA32 + 线性 2D；UMAP（邻居 30 / 最小距离 0.1 / 余弦）仅用于后台/回放  
- **聚类**：MiniBatchKMeans，K=8–12（状态地铁图）  
- **映射**：色相=说话人/状态；线宽=RMS；亮度/光晕=F0；粒子=重音；尾迹透明度=语义强度（L10）  
- **关键词**：更新间隔 0.5–1.0 s；显示时长 1.5–2.5 s；置信阈值与去重启用  
- **情感**：V–A 二维指示；色温与光晕分别映射效价/唤醒度  
- **性能预算**：端到端主观延迟目标 150–200 ms；GPU 忙时允许丢中间帧

---

## 10) 性能与降级策略

- **Base 优先**：直播演示使用 Base；如需更强语义，可在后台用 Large 更新锚点或训练在 Base 隐藏态上的小头。  
- **量化与并行**：半精度/INT8、批量化帧处理、只取选定层（2/6/10）。  
- **回退路径**：UMAP 卡顿 → PCA-only；关键词/情感延迟 → 先不显示或透明度降低。

---

## 11) 交付清单（评审所见）

1. **实时页面**：彗星轨迹（含尾迹/亮度/线宽/颜色），Analysis & Performance 两档切换。  
2. **辅助视图**：状态地铁图（时间状态条 + 转移矩阵），与轨迹联动高亮。  
3. **语义层次**：关键词气泡、主题背景、情感指示（可开关）。  
4. **质量背书**：2 项相关性统计 + 1 项轻因果示例（图注与文字说明）。  
5. **素材与文档**：3 段样例（朗读/对话/主题切换）、关键截图/GIF、参数表（本文件）。

---

## 12) 风险与边界

- **UMAP 在线性**：工程上最稳是固定 UMAP 后仅 `transform`；实况以 **PCA-only** 为主。  
- **语义/情感正确性**：作为**指示**而非“金标准”，UI 用透明度/置信度表达不确定性。  
- **硬件限制**：<100 ms 严格指标在通用设备上难以保证；以 **150–200 ms 主观实时**为可交付目标。  
- **隐私与版权**：实时音频处理需提示用户授权与用途限定。

---

## 13) 实施里程碑（两天版示例）

- **Day 1 上午**：PCA-only 实时彗星（L6 主轨迹，L2/L10 辅助通道）；环形缓冲与 EMA；参数定标。  
- **Day 1 下午**：状态地铁图（KMeans）与轨迹联动；Performance 模式——节拍脉冲/情绪共振/交互滑块。  
- **Day 2 上午**：关键词气泡与主题背景（0.5–1.0 s 更新，门控与去重）；情感指示。  
- **Day 2 下午**：相关性统计 + 轻因果回放；录制 3 段样例与 GIF；整理说明与参数表。

---

### 结语

以 **WavLM Base 的 L2/L6/L10** 为信息骨架，采用 **PCA-only 实时主通道 + UMAP 回放增强** 的双轨策略，既能达到**流畅即时**的观感，又能在**语义/情感**与**表演互动**上提供足够的表达力。配合稳定的映射规范与质量背书，这套“语义彗星轨迹”足以在评审场景里兼顾“可看性”与“可信度”。
